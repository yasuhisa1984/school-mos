!function(c){window.NestedFormEvents=function(){this.addFields=c.proxy(this.addFields,this),this.removeFields=c.proxy(this.removeFields,this)},NestedFormEvents.prototype={addFields:function(e){var t=e.currentTarget,r=c(t).data("association"),d=c("#"+c(t).data("blueprint-id")).data("blueprint"),i=(c(t).closest(".fields").closestChild("input, textarea, select").eq(0).attr("name")||"").replace(new RegExp("[[a-z_]+]$"),"");if(i)for(var n=i.match(/[a-z_]+_attributes(?=\]\[(new_)?\d+\])/g)||[],s=i.match(/[0-9]+/g)||[],a=0;a<n.length;a++)s[a]&&(d=(d=d.replace(new RegExp("(_"+n[a]+")_.+?_","g"),"$1_"+s[a]+"_")).replace(new RegExp("(\\["+n[a]+"\\])\\[.+?\\]","g"),"$1["+s[a]+"]"));var l=new RegExp("new_"+r,"g"),o=this.newId();d=c.trim(d.replace(l,o));var f=this.insertFields(d,r,t);return f.trigger({type:"nested:fieldAdded",field:f}).trigger({type:"nested:fieldAdded:"+r,field:f}),!1},newId:function(){return(new Date).getTime()},insertFields:function(e,t,r){var d=c(r).data("target");return d?c(e).appendTo(c(d)):c(e).insertBefore(r)},removeFields:function(e){var t=c(e.currentTarget),r=t.data("association");t.prev("input[type=hidden]").val("1");var d=t.closest(".fields");return d.hide(),d.trigger({type:"nested:fieldRemoved",field:d}).trigger({type:"nested:fieldRemoved:"+r,field:d}),!1}},window.nestedFormEvents=new NestedFormEvents,c(document).delegate("form a.add_nested_fields","click",nestedFormEvents.addFields).delegate("form a.remove_nested_fields","click",nestedFormEvents.removeFields)}(jQuery),function(n){n.fn.closestChild=function(e){if(e&&""!=e){var t=[];for(t.push(this);0<t.length;)for(var r=t.shift().children(),d=0;d<r.length;++d){var i=n(r[d]);if(i.is(e))return i;t.push(i)}}return n()}}(jQuery);