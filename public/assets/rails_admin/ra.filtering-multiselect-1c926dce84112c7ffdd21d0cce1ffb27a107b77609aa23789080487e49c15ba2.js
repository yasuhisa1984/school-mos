!function(n){n.widget("ra.filteringMultiselect",{_cache:{},options:{createQuery:function(e){return{query:e}},sortable:!1,removable:!0,regional:{up:"Up",down:"Down",add:"Add",chooseAll:"Choose all",chosen:"Chosen records",clearAll:"Clear all",remove:"Remove"},searchDelay:400,remote_source:null,xhr:!1},_create:function(){this._cache={},this._build(),this._buildCache(),this._bindEvents()},_build:function(){var e;for(e in this.wrapper=n('<div class="ra-multiselect">'),this.wrapper.insertAfter(this.element),this.header=n('<div class="ra-multiselect-header ui-helper-clearfix">'),this.filter=n('<input type="search" placeholder="'+this.options.regional.search+'" class="form-control ra-multiselect-search"/>'),this.header.append(this.filter),this.wrapper.append(this.header),this.columns={left:n('<div class="ra-multiselect-column ra-multiselect-left">'),center:n('<div class="ra-multiselect-column ra-multiselect-center">'),right:n('<div class="ra-multiselect-column ra-multiselect-right">')},this.columns)this.columns.hasOwnProperty(e)&&this.wrapper.append(this.columns[e]);this.collection=n('<select multiple="multiple"></select>'),this.collection.addClass("form-control ra-multiselect-collection"),this.addAll=n('<a href="#" class="ra-multiselect-item-add-all"><span class="ui-icon ui-icon-circle-triangle-e"></span>'+this.options.regional.chooseAll+"</a>"),this.columns.left.html(this.collection).append(this.addAll),this.collection.wrap('<div class="wrapper"/>'),this.add=n('<a href="#" class="ui-icon ui-icon-circle-triangle-e ra-multiselect-item-add">'+this.options.regional.add+"</a>"),this.columns.center.append(this.add),this.options.removable&&(this.remove=n('<a href="#" class="ui-icon ui-icon-circle-triangle-w ra-multiselect-item-remove">'+this.options.regional.remove+"</a>"),this.columns.center.append(this.remove)),this.options.sortable&&(this.up=n('<a href="#" class="ui-icon ui-icon-circle-triangle-n ra-multiselect-item-up">'+this.options.regional.up+"</a>"),this.down=n('<a href="#" class="ui-icon ui-icon-circle-triangle-s ra-multiselect-item-down">'+this.options.regional.down+"</a>"),this.columns.center.append(this.up).append(this.down)),this.selection=n('<select class="form-control ra-multiselect-selection" multiple="multiple"></select>'),this.columns.right.append(this.selection),this.options.removable&&(this.removeAll=n('<a href="#" class="ra-multiselect-item-remove-all"><span class="ui-icon ui-icon-circle-triangle-w"></span>'+this.options.regional.clearAll+"</a>"),this.columns.right.append(this.removeAll)),this.selection.wrap('<div class="wrapper"/>'),this.element.css({display:"none"}),this.tooManyObjectsPlaceholder=n('<option disabled="disabled" />').text(RailsAdmin.I18n.t("too_many_objects")),this.noObjectsPlaceholder=n('<option disabled="disabled" />').text(RailsAdmin.I18n.t("no_objects")),this.options.xhr&&this.collection.append(this.tooManyObjectsPlaceholder)},_bindEvents:function(){var t=this;this.addAll.click(function(e){t._select(n("option",t.collection)),e.preventDefault(),t.selection.trigger("change")}),this.add.click(function(e){t._select(n(":selected",t.collection)),e.preventDefault(),t.selection.trigger("change")}),this.options.removable&&(this.removeAll.click(function(e){t._deSelect(n("option",t.selection)),e.preventDefault(),t.selection.trigger("change")}),this.remove.click(function(e){t._deSelect(n(":selected",t.selection)),e.preventDefault(),t.selection.trigger("change")}));var e=null;this.options.sortable&&(this.up.click(function(e){t._move("up",n(":selected",t.selection)),e.preventDefault()}),this.down.click(function(e){t._move("down",n(":selected",t.selection)),e.preventDefault()})),this.filter.bind("keyup click",function(){e&&clearTimeout(e),e=setTimeout(function(){t._queryFilter(t.filter.val())},t.options.searchDelay)})},_queryFilter:function(e){var o=this;o._query(e,function(e){var t,i=[];for(t=0;t<e.length;t++)o.selected(e[t].id)||i.push(t);if(0<i.length)for(o.collection[0].innerHTML="",t=0;t<i.length;t++){var l=n("<option></option>").prop("value",e[i[t]].id).prop("title",e[i[t]].label).text(e[i[t]].label);n(o.collection[0]).append(l)}else o.collection[0].innerHTML=o.noObjectsPlaceholder})},_buildCache:function(){var i=this;this.element.find("option").each(function(e,t){i._cache["o_"+t.value]={id:t.value,value:n(t).text()},t.selected?n(t).clone().appendTo(i.selection).prop("selected",!1).prop("title",n(t).text()):n(t).clone().appendTo(i.collection).prop("selected",!1).prop("title",n(t).text())})},_deSelect:function(e){var i=this;e.each(function(e,t){i.element.find('option[value="'+t.value+'"]').removeAttr("selected")}),n(e).appendTo(this.collection).prop("selected",!1)},_query:function(e,t){var i,l=[];if(""===e)if(this.options.xhr)this.collection.html(this.tooManyObjectsPlaceholder);else{for(i in this._cache)this._cache.hasOwnProperty(i)&&(option=this._cache[i],l.push({id:option.id,label:option.value}));t.apply(this,[l])}else if(this.options.xhr)n.ajax({beforeSend:function(e){e.setRequestHeader("Accept","application/json")},url:this.options.remote_source,data:this.options.createQuery(e),success:t});else{for(i in e=new RegExp(e+".*","i"),this._cache)this._cache.hasOwnProperty(i)&&e.test(this._cache[i].value)&&(option=this._cache[i],l.push({id:option.id,label:option.value}));t.apply(this,[l])}},_select:function(e){var l=this;e.each(function(e,t){var i=l.element.find('option[value="'+t.value+'"]');i.length?i.prop("selected",!0):l.element.append(n("<option></option>").prop("value",t.value).prop("selected",!0))}),n(e).appendTo(this.selection).prop("selected",!1)},_move:function(e,t){var o=this;"up"==e?t.each(function(e,t){var i=n(t).prev();if(0<i.length){var l=o.element.find('option[value="'+t.value+'"]');o.element.find('option[value="'+i[0].value+'"]').before(l),i.before(n(t))}}):(n.fn.reverse=[].reverse,t.reverse().each(function(e,t){var i=n(t).next();if(0<i.length){var l=o.element.find('option[value="'+t.value+'"]');o.element.find('option[value="'+i[0].value+'"]').after(l),i.after(n(t))}}))},selected:function(e){if(this.selection[0].querySelectorAll('option[value="'+e+'"]')[0])return!0},destroy:function(){this.wrapper.remove(),this.element.css({display:"inline"}),n.Widget.prototype.destroy.apply(this,arguments)}})}(jQuery);